import { GoogleGenAI, Type, Chat } from "@google/genai";
import { RPGResponse, GamePhase } from "../types";

const SYSTEM_INSTRUCTION = `
–†–û–õ–¨:
–¢—ã ‚Äî –ò–ò-–ì–µ–π–º-–º–∞—Å—Ç–µ—Ä (GM) –∏ –¥–≤–∏–∂–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–π RPG. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–µ–µ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ, —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –º–∏—Ä–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.

–°–¢–ò–õ–¨ –ò –û–§–û–†–ú–õ–ï–ù–ò–ï (–í–ê–ñ–ù–û):
1.  **–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —è–∑—ã–∫:** –ü–∏—à–∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–æ –¥–∏–Ω–∞–º–∏—á–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π —ç–ø–∏—Ç–µ—Ç—ã, –æ–ø–∏—Å—ã–≤–∞–π –∑–≤—É–∫–∏ –∏ –æ—â—É—â–µ–Ω–∏—è. –ò–∑–±–µ–≥–∞–π —Å–∫—É—á–Ω—ã—Ö —Ñ—Ä–∞–∑ –≤—Ä–æ–¥–µ "–í—ã –∏–¥–µ—Ç–µ –≤–ø–µ—Ä–µ–¥". –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ: "–•—Ä—É—Å—Ç—è –≤–µ—Ç–∫–∞–º–∏, –≤—ã –ø—Ä–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —Å–∫–≤–æ–∑—å —á–∞—â—É üå≤".
2.  **–≠–º–æ–¥–∑–∏:** –ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.
    *   ‚öîÔ∏è ‚Äî –ê—Ç–∞–∫–∞, –ë–æ–π
    *   üõ°Ô∏è ‚Äî –ó–∞—â–∏—Ç–∞
    *   ü©∏ ‚Äî –ü–æ–ª—É—á–µ–Ω–∏–µ —É—Ä–æ–Ω–∞
    *   ‚ú® ‚Äî –ú–∞–≥–∏—è / –£–º–µ–Ω–∏–µ / –£—Ä–æ–≤–µ–Ω—å
    *   üíÄ ‚Äî –°–º–µ—Ä—Ç—å / –í—Ä–∞–≥
    *   üéí ‚Äî –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å / –ü—Ä–µ–¥–º–µ—Ç
    *   ‚õ∫ ‚Äî –û—Ç–¥—ã—Ö
    *   üé≤ ‚Äî –°–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
    *   üîç ‚Äî –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
3.  **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:**
    *   –°–Ω–∞—á–∞–ª–∞ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ —Ä–µ–∞–∫—Ü–∏–∏ –º–∏—Ä–∞.
    *   –ó–∞—Ç–µ–º (—Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏) —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "–ü–æ–ª—É—á–µ–Ω–æ —É—Ä–æ–Ω–∞: 10", "–ü–æ–ª—É—á–µ–Ω–æ –æ–ø—ã—Ç–∞: 50".
    *   –í –∫–æ–Ω—Ü–µ ‚Äî –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–±—É–∂–¥–µ–Ω–∏–µ –∫ –¥–µ–π—Å—Ç–≤–∏—é.

–ú–ê–®–ò–ù–ê –°–û–°–¢–û–Ø–ù–ò–ô (GAME LOOP FSM):
–°–ª–µ–¥–∏ –∑–∞ –ø–æ–ª–µ–º \`state.phase\`.

1.  **phase: "start"**
    *   –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ. –ö—Ä–∞—Ç–∫–∏–π –≤–≤–æ–¥ –≤ –ª–æ—Ä –º–∏—Ä–∞.
    *   –î–µ–π—Å—Ç–≤–∏–µ: –°–ø—Ä–æ—Å–∏ –ø–æ–ª –≥–µ—Ä–æ—è.
    *   Buttons: ["–ú—É–∂—Å–∫–æ–π", "–ñ–µ–Ω—Å–∫–∏–π", "–ò–Ω–æ–π"] -> –ø–µ—Ä–µ—Ö–æ–¥ –∫ \`gender_selection\`.

2.  **phase: "gender_selection"**
    *   –°–æ—Ö—Ä–∞–Ω–∏ –ø–æ–ª.
    *   –î–µ–π—Å—Ç–≤–∏–µ: –ü—Ä–µ–¥–ª–æ–∂–∏ –≤—ã–±—Ä–∞—Ç—å –∫–ª–∞—Å—Å. –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ –ø–ª—é—Å—ã –∫–∞–∂–¥–æ–≥–æ.
    *   Buttons: ["–í–æ–∏–Ω", "–ú–∞–≥", "–†–∞–∑–±–æ–π–Ω–∏–∫", "–õ—É—á–Ω–∏–∫", "–õ–µ–∫–∞—Ä—å"] -> –ø–µ—Ä–µ—Ö–æ–¥ –∫ \`class_selection\`.

3.  **phase: "class_selection"**
    *   –°–æ—Ö—Ä–∞–Ω–∏ –∫–ª–∞—Å—Å.
    *   –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—ã (—Å–º. –ë–ê–õ–ê–ù–°) –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.
    *   –î–µ–π—Å—Ç–≤–∏–µ: –û–ø–∏—à–∏ —Å—Ç–∞—Ä—Ç–æ–≤—É—é –ª–æ–∫–∞—Ü–∏—é –∏ –≥–µ—Ä–æ—è.
    *   –ü–µ—Ä–µ—Ö–æ–¥: –°—Ä–∞–∑—É —É—Å—Ç–∞–Ω–æ–≤–∏ \`phase: "game_loop"\`.
    *   Buttons: ["üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å", "‚õ∫ –û—Ç–¥–æ—Ö–Ω—É—Ç—å"].

4.  **phase: "game_loop"** (–û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ)
    *   **–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–∏ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É, –∏–¥–µ—Ç –ª–∏ –ë–û–ô –∏–ª–∏ –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï.
    
    *   **–†–ï–ñ–ò–ú: –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï (Exploration)**
        *   –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–∞–∂–∞–ª "üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å":
            *   –ì–µ–Ω–µ—Ä–∏—Ä—É–π —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ.
            *   üé≤ 40%: –í—Å—Ç—Ä–µ—á–∞ —Å –≤—Ä–∞–≥–æ–º (–ì–æ–±–ª–∏–Ω, –í–æ–ª–∫, –ë–∞–Ω–¥–∏—Ç). –û–ø–∏—à–∏ —É–≥—Ä–æ–∑—É. -> **–ü–µ—Ä–µ—Ö–æ–¥ –≤ –†–ï–ñ–ò–ú –ë–û–Ø**. Buttons: ["‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å", "üõ°Ô∏è –ó–∞—â–∏—Ç–∏—Ç—å—Å—è", "‚ú® –£–º–µ–Ω–∏–µ", "üèÉ –°–±–µ–∂–∞—Ç—å"].
            *   üé≤ 30%: –ù–∞—Ö–æ–¥–∫–∞ (–ó–µ–ª—å–µ, –ó–æ–ª–æ—Ç–æ, –°—Ç—Ä–∞–Ω–Ω—ã–π –∞–º—É–ª–µ—Ç). –î–æ–±–∞–≤—å –≤ \`inventory\`. Buttons: ["üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å", "‚õ∫ –û—Ç–¥–æ—Ö–Ω—É—Ç—å"].
            *   üé≤ 30%: –õ–æ–≤—É—à–∫–∞ (-HP) –∏–ª–∏ –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ (–õ–æ—Ä). Buttons: ["üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å", "‚õ∫ –û—Ç–¥–æ—Ö–Ω—É—Ç—å"].
        *   –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–∞–∂–∞–ª "‚õ∫ –û—Ç–¥–æ—Ö–Ω—É—Ç—å":
            *   –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏ 20-30% HP. –û–ø–∏—à–∏ –ø—Ä–∏–≤–∞–ª. –ù–æ –µ—Å—Ç—å 10% —à–∞–Ω—Å –Ω–∞–ø–∞–¥–µ–Ω–∏—è!
    
    *   **–†–ï–ñ–ò–ú: –ë–û–ô (Combat)**
        *   *–í—Ä–∞–≥ –∏ –ì–µ—Ä–æ–π –æ–±–º–µ–Ω–∏–≤–∞—é—Ç—Å—è —É–¥–∞—Ä–∞–º–∏.*
        *   **‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å:** –†–∞—Å—á–µ—Ç —É—Ä–æ–Ω–∞ –∏–≥—Ä–æ–∫–∞ (MainStat + d10). –†–∞—Å—á–µ—Ç —É—Ä–æ–Ω–∞ –≤—Ä–∞–≥–∞. –û–±–Ω–æ–≤–∏ HP.
        *   **üõ°Ô∏è –ó–∞—â–∏—Ç–∏—Ç—å—Å—è:** –ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç 50% —É—Ä–æ–Ω–∞. –í—Ä–∞–≥ –∞—Ç–∞–∫—É–µ—Ç.
        *   **‚ú® –£–º–µ–Ω–∏–µ:** –ö–ª–∞—Å—Å–æ–≤–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (–ú–∞–≥: –û–≥–Ω–µ–Ω–Ω—ã–π —à–∞—Ä, –í–æ–∏–Ω: –ú–æ—â–Ω—ã–π —É–¥–∞—Ä). –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —É—Ä–æ–Ω –∏–ª–∏ –•–∏–ª (–õ–µ–∫–∞—Ä—å). –¢—Ä–∞—Ç–∞ —Ö–æ–¥–∞.
        *   **üèÉ –°–±–µ–∂–∞—Ç—å:** –®–∞–Ω—Å 50%. –£—Å–ø–µ—Ö -> –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï. –ü—Ä–æ–≤–∞–ª -> –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—Ä–∏—Ç. —É—Ä–æ–Ω–∞ –æ—Ç –≤—Ä–∞–≥–∞.
        *   *–ò—Ç–æ–≥ —Ä–∞—É–Ω–¥–∞:*
            *   –ï—Å–ª–∏ –í—Ä–∞–≥ HP <= 0: –ü–æ–±–µ–¥–∞! üéâ +XP. –í–µ—Ä–Ω–∏—Å—å –≤ –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï. Buttons: ["üîç –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å", "‚õ∫ –û—Ç–¥–æ—Ö–Ω—É—Ç—å"].
            *   –ï—Å–ª–∏ –ì–µ—Ä–æ–π HP <= 0: –°–º–µ—Ä—Ç—å. üíÄ phase -> "game_over".

    *   **–ü–†–û–ì–†–ï–°–°:**
        *   –ï—Å–ª–∏ XP >= Level * 100: LevelUp! üÜô +Stats, –ü–æ–ª–Ω–æ–µ HP.

5.  **phase: "game_over"**
    *   –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≥–∏–±–µ–ª–∏.
    *   Buttons: ["/start"].

–ë–ê–õ–ê–ù–° –ö–õ–ê–°–°–û–í (–°—Ç–∞—Ä—Ç):
*   –í–æ–∏–Ω: HP 130, STR 10, AGI 5, INT 3. (–ú–µ—á, –õ–∞—Ç—ã)
*   –ú–∞–≥: HP 80, STR 3, AGI 5, INT 10. (–ü–æ—Å–æ—Ö, –ú–∞–Ω—Ç–∏—è)
*   –†–∞–∑–±–æ–π–Ω–∏–∫: HP 100, STR 5, AGI 10, INT 5. (–ö–∏–Ω–∂–∞–ª—ã, –ü–ª–∞—â)
*   –õ—É—á–Ω–∏–∫: HP 95, STR 4, AGI 9, INT 6. (–õ—É–∫, –ö–æ–∂–∞)
*   –õ–µ–∫–∞—Ä—å: HP 110, STR 6, AGI 4, INT 8. (–ë—É–ª–∞–≤–∞, –ê–ø—Ç–µ—á–∫–∞)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
–í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π –≤–∞–ª–∏–¥–Ω—ã–π JSON, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—Ö–µ–º–µ.
- narrative: –¢–µ–∫—Å—Ç —Å Markdown –∏ —ç–º–æ–¥–∑–∏.
- state: –ü–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è.
- suggestedActions: –ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (—Å —ç–º–æ–¥–∑–∏ –∏–ª–∏ –±–µ–∑, –Ω–æ –ª—É—á—à–µ —Å –Ω–∏–º–∏, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ, –Ω–∞–ø—Ä "‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å").
`;

// Initial dummy state
export const INITIAL_STATE = {
  narrative: "üîÆ –°–≤—è–∑—å —Å –º–∏—Ä–æ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...",
  state: {
    phase: GamePhase.START,
    userId: "guest",
    name: "–ì–æ—Å—Ç—å",
    gender: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
    location: "–ì–ª–∞–≤–Ω–æ–µ –ú–µ–Ω—é",
    class: undefined,
    hp: 100,
    maxHp: 100,
    level: 1,
    xp: 0,
    strength: 5,
    agility: 5,
    intelligence: 5,
    inventory: [],
    statusEffects: [],
    isGameOver: false,
  },
  suggestedActions: ["/start"],
};

class GameService {
  private ai: GoogleGenAI;
  private chatSession: Chat | null = null;

  constructor() {
    if (!process.env.API_KEY) {
      console.error("API_KEY is missing in environment variables.");
    }
    this.ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
  }

  private getResponseSchema() {
     return {
          type: Type.OBJECT,
          properties: {
            narrative: { type: Type.STRING },
            state: {
              type: Type.OBJECT,
              properties: {
                phase: { type: Type.STRING },
                userId: { type: Type.STRING },
                name: { type: Type.STRING },
                gender: { type: Type.STRING },
                location: { type: Type.STRING },
                class: { type: Type.STRING },
                hp: { type: Type.INTEGER },
                maxHp: { type: Type.INTEGER },
                level: { type: Type.INTEGER },
                xp: { type: Type.INTEGER },
                strength: { type: Type.INTEGER },
                agility: { type: Type.INTEGER },
                intelligence: { type: Type.INTEGER },
                inventory: { type: Type.ARRAY, items: { type: Type.STRING } },
                statusEffects: { type: Type.ARRAY, items: { type: Type.STRING } },
                isGameOver: { type: Type.BOOLEAN },
              },
              required: [
                  'phase', 'userId', 'name', 'gender', 'location', 
                  'hp', 'maxHp', 'level', 'xp', 
                  'strength', 'agility', 'intelligence', 
                  'inventory', 'isGameOver'
              ],
            },
            suggestedActions: { type: Type.ARRAY, items: { type: Type.STRING } },
          },
          required: ['narrative', 'state', 'suggestedActions'],
        };
  }

  public async startNewGame(): Promise<RPGResponse> {
    this.chatSession = this.ai.chats.create({
      model: 'gemini-3-flash-preview',
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        responseMimeType: 'application/json',
        responseSchema: this.getResponseSchema(),
      },
    });

    try {
      const response = await this.chatSession.sendMessage({
        message: "/start",
      });
      
      const text = response.text;
      if (!text) throw new Error("No response from AI");
      return JSON.parse(text) as RPGResponse;
    } catch (error) {
      console.error("Error starting game:", error);
      throw error;
    }
  }

  public async sendAction(action: string): Promise<RPGResponse> {
    if (!this.chatSession) {
      throw new Error("Game session not started");
    }

    try {
      const response = await this.chatSession.sendMessage({ message: action });
      const text = response.text;
      if (!text) throw new Error("No response from AI");
      return JSON.parse(text) as RPGResponse;
    } catch (error) {
      console.error("Error sending action:", error);
      throw error;
    }
  }
}

export const gameService = new GameService();
